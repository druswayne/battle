{% extends "base.html" %}

{% block title %}{{ tournament.name }} - –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
            <h1 class="mb-0">
                <i class="fas fa-trophy text-warning"></i> {{ tournament.name }}
            </h1>
            <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
                {% if session.admin_logged_in %}
                    <a href="{{ url_for('admin') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">–ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏</span><span class="d-inline d-sm-none">–ù–∞–∑–∞–¥</span>
                    </a>
                    <button type="button" class="btn btn-danger" 
                            data-bs-toggle="modal" data-bs-target="#deleteTournamentModal">
                        <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</span><span class="d-inline d-sm-none">–£–¥–∞–ª–∏—Ç—å</span>
                    </button>
                {% else %}
                    <a href="{{ url_for('index') }}" class="btn btn-secondary w-100">
                        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    </a>
                {% endif %}
            </div>
        </div>
        
        <div class="alert alert-{{ 'success' if tournament.status == 'completed' else 'info' }}">
            <i class="fas fa-{{ 'trophy' if tournament.status == 'completed' else 'info-circle' }}"></i> 
            –°—Ç–∞—Ç—É—Å —Ç—É—Ä–Ω–∏—Ä–∞: 
            <span class="badge bg-{{ 'success' if tournament.status == 'completed' else 'primary' }}">
                {{ '–ó–∞–≤–µ—Ä—à–µ–Ω' if tournament.status == 'completed' else '–ê–∫—Ç–∏–≤–µ–Ω' }}
            </span>
            | –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ tournament.participants|length }}
            
            {% if tournament.status == 'completed' %}
                {% set final_winner = tournament.matches|selectattr('is_completed')|selectattr('round_number', 'equalto', rounds.keys()|list|max)|first %}
                {% if final_winner and final_winner.winner %}
                    <br>
                    <i class="fas fa-crown text-warning"></i>
                    <strong>üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨ –¢–£–†–ù–ò–†–ê: {{ final_winner.winner.name }}! üèÜ</strong>
                {% endif %}
            {% elif not session.admin_logged_in %}
                <br>
                <i class="fas fa-shield-alt text-warning"></i> 
                <strong>–¢–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:</strong> –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            {% endif %}
        </div>
        
        <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ -->
        <div class="bracket-container">
            <div class="scroll-indicator d-md-none">
                <div class="scroll-progress"></div>
            </div>
            <div class="tournament-bracket">
            {% for round_num, matches in rounds.items() %}
            <div class="round">
                <div class="round-title">
                    {{ round_names[round_num] }}
                </div>
                <div class="round-rules">
                    {% set total_rounds = rounds.keys()|list|max %}
                    {% if round_num == total_rounds %}
                        <i class="fas fa-trophy"></i> –î–æ 3 –ø–æ–±–µ–¥
                    {% elif round_num == total_rounds - 1 or round_num == total_rounds - 2 %}
                        <i class="fas fa-medal"></i> –î–æ 2 –ø–æ–±–µ–¥
                    {% else %}
                        <i class="fas fa-fire"></i> –î–æ 1 –ø–æ–±–µ–¥—ã
                    {% endif %}
                </div>
                
                {% for match in matches %}
                <div class="match {% if match.is_completed %}completed{% endif %}">
                    {% if match.round_number > 1 %}
                        <div class="connection-line"></div>
                    {% endif %}
                    
                    <div class="match-info">
                        {% if match.player1 %}
                            <div class="player {% if match.winner_id == match.player1_id %}winner{% elif match.is_completed and match.winner_id != match.player1_id %}loser{% endif %}">
                                {{ match.player1.name }}
                            </div>
                        {% elif match.player1_id %}
                            <div class="player">
                                –ò–≥—Ä–æ–∫ ID: {{ match.player1_id }}
                            </div>
                        {% else %}
                            <div class="player" style="color: #495057; font-weight: 600;">TBD</div>
                        {% endif %}
                        
                        <div class="vs-text text-muted">VS</div>
                        
                        {% if match.player2 %}
                            <div class="player {% if match.winner_id == match.player2_id %}winner{% elif match.is_completed and match.winner_id != match.player2_id %}loser{% endif %}">
                                {{ match.player2.name }}
                            </div>
                        {% elif match.player2_id %}
                            <div class="player">
                                –ò–≥—Ä–æ–∫ ID: {{ match.player2_id }}
                            </div>
                        {% else %}
                            <div class="player" style="color: #495057; font-weight: 600;">TBD</div>
                        {% endif %}
                    </div>
                    
                    {% if not match.is_completed and match.player1 and match.player2 %}
                        {% if session.admin_logged_in %}
                            <div class="winner-selection mt-2">
                                <form method="POST" action="{{ url_for('set_winner') }}" class="d-inline">
                                    <input type="hidden" name="match_id" value="{{ match.id }}">
                                    <div class="btn-group-vertical">
                                        <button type="submit" name="winner_id" value="{{ match.player1_id }}" 
                                                class="winner-button">
                                            <i class="fas fa-crown"></i> {{ match.player1.name }}
                                        </button>
                                        <button type="submit" name="winner_id" value="{{ match.player2_id }}" 
                                                class="winner-button">
                                            <i class="fas fa-crown"></i> {{ match.player2.name }}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        {% else %}
                            <div class="match-pending mt-2">
                                <span class="badge bg-warning">
                                    <i class="fas fa-clock"></i> <span class="d-none d-sm-inline">–û–∂–∏–¥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</span><span class="d-inline d-sm-none">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                                </span>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        <span class="d-none d-sm-inline">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</span>
                                        <span class="d-inline d-sm-none">–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞</span>
                                    </small>
                                </div>
                            </div>
                        {% endif %}
                    {% elif match.is_completed %}
                        <div class="winner-info mt-2">
                            <span class="badge bg-success">
                                <i class="fas fa-trophy"></i> <span class="d-none d-sm-inline">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:</span> {{ match.winner.name }}
                            </span>
                            {% if match.round_number < rounds.keys()|list|max %}
                                <div class="mt-1">
                                    <small class="text-success">
                                        <i class="fas fa-arrow-up"></i> <span class="d-none d-sm-inline">–ü–µ—Ä–µ—à–µ–ª –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</span><span class="d-inline d-sm-none">–î–∞–ª–µ–µ</span>
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–µ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—É—Ä–Ω–∏—Ä–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ tournament.participants|length }}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>–í—Å–µ–≥–æ —Ä–∞—É–Ω–¥–æ–≤:</strong> {{ rounds.keys()|list|max if rounds else 0 }}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>–í—Å–µ–≥–æ –º–∞—Ç—á–µ–π:</strong> {{ tournament.matches|length }}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π:</strong> {{ tournament.matches|selectattr('is_completed')|list|length }}</p>
                            </div>
                        </div>
                        
                        {% set winner = tournament.matches|selectattr('is_completed')|selectattr('round_number', 'equalto', rounds.keys()|list|max)|first %}
                        {% if winner and winner.winner %}
                        <hr>
                        <div class="text-center">
                            <h4 class="text-success">
                                <i class="fas fa-trophy"></i> –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ç—É—Ä–Ω–∏—Ä–∞!
                            </h4>
                            <h3 class="text-warning">{{ winner.winner.name }}</h3>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
setInterval(function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –º–∞—Ç—á–∏
    const incompleteMatches = document.querySelectorAll('.match:not(.completed)');
    if (incompleteMatches.length > 0) {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        console.log('–ï—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –º–∞—Ç—á–∏');
    }
}, 30000);

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const bracket = document.querySelector('.tournament-bracket');
    const scrollProgress = document.querySelector('.scroll-progress');
    
    if (bracket && scrollProgress) {
        bracket.addEventListener('scroll', function() {
            const scrollLeft = bracket.scrollLeft;
            const scrollWidth = bracket.scrollWidth - bracket.clientWidth;
            const scrollPercentage = (scrollLeft / scrollWidth) * 100;
            scrollProgress.style.width = scrollPercentage + '%';
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const scrollWidth = bracket.scrollWidth - bracket.clientWidth;
        if (scrollWidth > 0) {
            scrollProgress.style.width = '0%';
        } else {
            // –ï—Å–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞, —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            const indicator = document.querySelector('.scroll-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
    }
});
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ -->
{% if session.admin_logged_in %}
<div class="modal fade" id="deleteTournamentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> –£–¥–∞–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-warning"></i>
                    <strong>–í–ù–ò–ú–ê–ù–ò–ï!</strong><br>
                    –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä <strong>"{{ tournament.name }}"</strong>.
                </div>
                
                <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç:</p>
                <ul>
                    <li>–í—Å–µ –º–∞—Ç—á–∏ —Ç—É—Ä–Ω–∏—Ä–∞ ({{ tournament.matches|length }})</li>
                    <li>–í—Å–µ —É—á–∞—Å—Ç–∏—è –≤ —Ç—É—Ä–Ω–∏—Ä–µ ({{ tournament.participants|length }})</li>
                    <li>–°–∞–º —Ç—É—Ä–Ω–∏—Ä</li>
                </ul>
                
                <p class="text-danger"><strong>–≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞!</strong></p>
                
                <form method="POST" action="{{ url_for('delete_tournament', tournament_id=tournament.id) }}">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
